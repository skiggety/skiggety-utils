#!/usr/bin/env ruby

require_relative '../lib/installable_skiggety_util.rb'

class VimInstaller

  include InstallableSkiggetyUtil

  def self.run # TODO TODO: EXTRACT to InstallableSkiggetyUtil
    self.new.run
  end

  def apparently_installed?
    vim_version = `vim --version | head -n 1`
    return (vim_version =~ / 8\.0 / ).is_a?(Numeric) # TODO: update desired vim version and make sure it includes the gui version, too
  end

  # err on the side of returning false...if these files don't match perfectly the user will have a chance to make sure it's set up right.
  def apparently_configured?
    if ( ! File.exist?(user_vimrc_path) )
      return false
    end
    FileUtils.compare_file(user_vimrc_path, template_vimrc_path)
  end

  def install
    if $interactive
      system("#{__dir__}/../bin/ask_user_to 'make sure vim is installed'")
      unless ( $?.exitstatus == 0 )
        raise "user failed to install vim"
      end
    else
      raise "Cannot install vim in non-interactive mode, user should run \"install_me\" or \"#{__FILE__}\"." # TODO: EXTRACT to InstallableSkiggetyUtil module
    end
  end

  def configure
    if $interactive
      system("vim -do #{user_vimrc_path} #{template_vimrc_path}")
    else
      raise "Cannot configure vim in non-interactive mode, user should run \"install_me\" or \"#{__FILE__}\"." # TODO: EXTRACT to InstallableSkiggetyUtil module
    end
  end

  def user_vimrc_path
    File.expand_path('~/.vimrc')
  end

  def template_vimrc_path
    File.join(config_dir_path,'vimrc')
  end

end

VimInstaller.run
