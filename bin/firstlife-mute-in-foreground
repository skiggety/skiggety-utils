#!/usr/bin/env bash

# This script mutes all firstlife sounds for a certain duration (in the foreground).

. $SKIGGETY_UTILS_DIR/lib/skiggety-utils.bash || exit 1
. $SKIGGETY_UTILS_DIR/lib/firstlife.bash || exit_with_error 'could not use common firstlife code'

SKIGGETY_DEBUG=true # TODO: DELETE

MUTE_DURATION_IN_SECONDS="300"
debug_eval_here MUTE_DURATION_IN_SECONDS
while [[ "$1" == -* ]]; do
    if [ "$1" == '-t' -o "$1" == '--time-in-seconds' ]; then
        shift
        MUTE_DURATION_IN_SECONDS="$1"
        debug_eval_here MUTE_DURATION_IN_SECONDS
        shift
    fi
    # - TODO?: accept other argument as a message
done

# write ppid in mute file
FIRSTLIFE_MUTE_FILE="${FIRSTLIFE_MUTE_FILE_PREFIX}${PPID}"
debug_eval_here FIRSTLIFE_MUTE_FILE_PREFIX
debug_eval_here FIRSTLIFE_MUTE_FILE
echo $PPID > $FIRSTLIFE_MUTE_FILE

debug_eval_here MUTE_DURATION_IN_SECONDS
sleep-verbose $MUTE_DURATION_IN_SECONDS

# Un-mute at the end by deleting mute file if this is the last process to mute:
if [ -f $FIRSTLIFE_MUTE_FILE ]; then
    echo "End of mute period for process $PPID, deleting '$FIRSTLIFE_MUTE_FILE'."
    rm -f $FIRSTLIFE_MUTE_FILE
fi
