#!/usr/bin/env bash

# This script asks you to work on each todo list entry tracked by vital matching a certain tag.

# Usage: firstlife-iterate-on-vital-tag <tag> # where <tag> might be 'DAILY' or some such

. $SKIGGETY_UTILS_DIR/lib/skiggety-utils.bash || exit 1
. $SKIGGETY_UTILS_DIR/lib/firstlife.bash || exit_with_error 'could not use common firstlife code'

# EASY TODO^10: take an option to use pomodoros for each item, for much increased focus

LIMIT=""
while [[ "$1" == -* ]]; do
    # accept -n to accept a number of tasks to work on:
    if [ "$1" == "-n" ]; then
        shift
        LIMIT="$1"
        shift
    fi
    # TODO: --help/-h with usage
done

tagged_todos="$(vital-list-by-tag "$1" | tac)"
if ! [ -z "$LIMIT" ]; then
    echo_debug "$(basename $0) - limiting to $LIMIT iterations"
    tagged_todos="$(echo "$tagged_todos" | head -n $LIMIT)"
fi

ORIGINAL_IFS="$IFS"
IFS=$'\n'
read -rd '' -a tagged_todos_as_array <<<"$tagged_todos"
for todo_line in ${tagged_todos_as_array[@]};do
    # TODO: make a version of this script that uses: firstlife-delegate --limit-n-times-per-x 1 day:
    # TODO: make a version of this script that uses: firstlife-delegate --limit-n-times-per-x 1 week:
    firstlife-delegate --with-reward "Work on this task (and downvote or mark done using today_todo):${newline}${todo_line}" \
        || accumulate_error "Didn't work on todo: $todo_line"
    exit_if_day_is_over

done
IFS="$ORIGINAL_IFS"
