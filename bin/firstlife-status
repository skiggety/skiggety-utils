#!/usr/bin/env bash

# This script displays progress on firstlife

. $SKIGGETY_UTILS_DIR/lib/skiggety-utils.bash || exit 1
. $SKIGGETY_UTILS_DIR/lib/firstlife.bash || exit_with_error 'could not use common firstlife code'

EXPECTED_PID=""
while [[ "$1" == -* ]]; do
    if [[ "$1" == '--while-review-pid-latest' ]]; then
        shift
        EXPECTED_PID="$1"
        shift
    fi
done

# TODO^43: function extract to firstlife.bash:
for blank_line_i in $(seq $(tput lines));do echo; done # push everything to the bottom of the terminal

echo_divider_with_text "...  " "KPI detail:"
pushd ~/firstlife/log
    rg "starting to focus" | sort
    rg "looked at URGENT" | grep "1/10x" | sort
popd

MINUTES_OF_INACTIVITY_ALLOWED=12 # TODO^4: make configurable and tune the number
debug_eval MINUTES_OF_INACTIVITY_ALLOWED
debug_here "(...but right now MINUTES_OF_INACTIVITY_ALLOWED is still hardcoded)"
TARGET_SECONDS_PER_REWARD=$(( 5 * 60 )) # TODO^4: make configurable and tune the number
debug_eval TARGET_SECONDS_PER_REWARD

# TODO: exit if after CHILL_TIME, BEDTIME, or maybe control bedtime with a cron marker file, or maybe just be silent
# instead of exiting

# TODO: dry with '../PWD_BIN/dashboard':
FIRSTLIFE_CODE_TODO_REPORT="$FIRSTLIFE_CODE_DIR/todo_report/todos_by_status.txt"
if [ -f $FIRSTLIFE_CODE_TODO_REPORT ]; then
    echo_divider_with_text "=" "TODO's for the firstlife codebase by status:" # IGNORE_TODO
    cat $FIRSTLIFE_CODE_TODO_REPORT | abbreviate -n 5 # TODO^10: prefer the color version if you find it
fi

echo
echo_divider_with_text "=" 'Your main TODO list from the "vital" program:'
today_todo --non-interactive | abbreviate -l 13 # TODO: vital --report | abbreviate -l 13

reward_status="$(firstlife-reward -n)"
echo "$reward_status" | abbreviate -l 6 -t 'firstlife-reward -n'

# EASY? FUN? TODO^52: zl-pomodoro -n # to show accumulating pomodoros like rewards for more motivation

# - EASY TODO^11: can also use mute at will
BEHIND_SOUND="$FIRSTLIFE_LOCAL_DIR/sounds/behind.mp3"
BEHIND_SOUND_VOLUME='3' # TODO^6: put in local config with this default:
while ! [ -f $BEHIND_SOUND ]; do
    mkdir -p "$(dirname $BEHIND_SOUND)"
    # TODO: do this in firstlife-setup:
    zl-delegate "Please download an sound to let you know you are behind of your choice and put it at $ALARM_SOUND, e.g. \"wget <some-whip-cracking-sound> -O $BEHIND_SOUND\"" \
        || exit_with_error "No sound to let you know you are behind available"
done

spr="$(echo "$reward_status"| grep 'seconds each' | sed 's/.*at \([0-9]*\) seconds each.*/\1/')"
spr=${spr:-'100000'}
debug_eval_here spr

# BEWARE, experiment with allowing this to stretch a litle based on current performance:
MINUTES_OF_INACTIVITY_ALLOWED=$(( ( $MINUTES_OF_INACTIVITY_ALLOWED + ( $spr / 60 ) ) / 2 ))
debug_eval_here MINUTES_OF_INACTIVITY_ALLOWED

# TODO: or if no rewards yet:
if [ $spr -gt $TARGET_SECONDS_PER_REWARD ] && test "`find $REWARD_LOG -mmin +$MINUTES_OF_INACTIVITY_ALLOWED 2>/dev/null`"; then
    echo
    if firstlife-is-muted >/dev/null 2>&1; then
        echo "UH-OH! It seems like you're getting BEHIND! (but firstlife is muted, so this won't emit a sound)"
    else
        echo "UH-OH! It seems like you're getting BEHIND, time to emit a sound: $BEHIND_SOUND"
        mplayer -volume $BEHIND_SOUND_VOLUME $BEHIND_SOUND >/dev/null 2>&1
    fi
    echo "...Also, here's the file with the last timestamp for a reward:"
    ls -lh $FIRSTLIFE_LOG_DIR/reward.$(isotoday).log.txt
fi

firstlife-is-muted
# TODO^152: similarly, show current alarms, especially if muted!!

if is_another_day; then
    exit_with_error "The day is over, run 'review-firstlife-status' again to monitor today's firstlife status"
fi

if ! [ -z "$EXPECTED_PID" ]; then
    debug_eval EXPECTED_PID
    echo_debug expecting pid to be the latest review-firstlife-status
    latest_review_pid=$(cat $FIRSTLIFE_MARKER_DIR/.review-firstlife-status_PID)
    debug_eval latest_review_pid
    if ! [ "$latest_review_pid" -eq "$EXPECTED_PID" ]; then
        exit_with_error "Exiting since process $latest_review_pid has taken over" # TODO^40: DEBUG THIS, it seems broken
    fi
fi
