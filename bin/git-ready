#!/usr/bin/env bash

. $SKIGGETY_UTILS_DIR/lib/skiggety-utils.bash

while [[ "$1" == -* ]]; do
    # accept -n for git commit -n
    if [ "$1" == "-n" ]; then
        GIT_COMMIT_OPTIONS="$GIT_COMMIT_OPTIONS $1"
        shift
    else
        exit_with_error "option not supported: $1"
    fi
done

# TODO^5: git vimdiff --staged should be optional
# TODO^2: un-loop:
# TODO: if the remote branch doesn't exist yet, we should skip trying git pull, since it will fail anyway
# TODO: stop before vimdiff if there is no git diff
for command in \
    'git add -p' \
    'git vimdiff --staged' \
    "git commit $GIT_COMMIT_OPTIONS" \
    'git pull' \
    'git push -u'
do
    # TODO^3: method extract:
    echo
    echo "running \"$command\" momentarily, press CTRL+C to stop..."
    pretty_sleep 2
    $command || exit_with_error "Command \"$command\" failed."
done

echo
git -c color.ui=always --no-pager log --oneline --decorate=short origin/HEAD~..HEAD -n 3

echo
echo "...finished '$(basename "$0")'."
