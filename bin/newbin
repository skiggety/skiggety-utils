#!/usr/bin/env bash

# Just a fast way to start editing a new script

# TODO: DRY functionality with vimwhich, there is or at least should be some overlap.  Maybe vimwhich should call newbin
# if it doesn't find the right script?

. $SKIGGETY_UTILS_DIR/lib/skiggety-utils.bash || exit 1

# overridable TEMPLATE_SOURCE_DIR for zl-newbin:
TEMPLATE_SOURCE_DIR="$SKIGGETY_UTILS_DIR/bin/templates"
debug_eval_here TEMPLATE_SOURCE_DIR
DESTINATION_DIR="$SKIGGETY_UTILS_DIR/bin"
while [[ "$1" == -* ]]; do
    if [ "$1" == '-d' ] || [ "$1" == '--destination-dir' ]; then
        shift
        DESTINATION_DIR="$1"
        shift
    elif [ "$1" == '--source-dir' ] || [ "$1" == '--template-source-dir' ]; then
        shift
        TEMPLATE_SOURCE_DIR="$1"
        debug_eval_here TEMPLATE_SOURCE_DIR
        shift
    fi
done
debug_eval_here TEMPLATE_SOURCE_DIR

new_file=''
if [ "$1" == "$(basename $1)" ];then # if no destination path is specified
    INTENDED_new_file="$DESTINATION_DIR/$(basename $1)"
    ANY_EXISTING="$(which "$1")"
    if [ -z "$ANY_EXISTING" ];then
        # overridable DESTINATION_DIR for zl-newbin's sake:
        new_file="$INTENDED_new_file"
    elif [ "$ANY_EXISTING" == "$INTENDED_new_file" ]; then
        new_file="$INTENDED_new_file"
    else
        exit_with_error "$INTENDED_new_file was specified but $ANY_EXISTING was found."
    fi
else
    SPECIFIED_new_file="$1"
    INTENDED_new_file="$SPECIFIED_new_file"
    if [ -n "$DESTINATION_DIR" ]; then
        INTENDED_new_file="$DESTINATION_DIR/$(basename $1)"
    fi
    if [ "$SPECIFIED_new_file" != "$INTENDED_new_file" ]; then
        exit_with_error "specified destination file $SPECIFIED_new_file conflicts with specified destination dir $DESTINATION_DIR"
    fi
    new_file="$SPECIFIED_new_file"
fi
debug_eval new_file
shift

if [ x"$@"x == x""x ]; then
    debug_here
    shebang_args="env bash"
else
    debug_here
    shebang_args="$@"
fi

if ! [ -f $new_file ]; then
    debug_eval_here shebang_args

    # TODO: frozen string literal thingy if ruby

    if [ "$shebang_args" == 'env bash' ];then
        debug_here

        # TODO^301: ( IN_PROGRESS NOW ) OVERRIDABLE NEWBIN_TEMPLATE_EXTENSION
        TEMPLATE="$TEMPLATE_SOURCE_DIR/newbin.template.bash"
        if ! ls $TEMPLATE;then
            exit_with_error "template not found: '$TEMPLATE'"
        fi
        sed 's/ooo//g' "$TEMPLATE" > $new_file
        debug_here
    fi

    chmod +x $new_file

fi

$EDITOR $new_file
chmod +x $new_file
