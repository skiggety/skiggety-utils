#!/usr/bin/env bash

# This script runs tests this project as much as possible, and exits with an error if it fails.

THIS_DIR="$(cd "$(dirname $BASH_SOURCE)";pwd)"
. $THIS_DIR/../lib/skiggety-utils.bash || exit 1

echo_divider_with_text "=" "test_all:"

# install skiggety-utils
echo_divider_with_text "-" "install-skiggety-utils --non-interactive"
$THIS_DIR/install-skiggety-utils --non-interactive || accumulate_error "could not run installers for skiggety-utils"

# run ruby unit tests
echo_divider_with_text "-" "rake test"
rake_test_output="$(rake test)" || accumulate_error "rake test FAILED"
# trim blank space and anything non-deterministic out of test output:
echo "$rake_test_output" | grep -v " --seed" | grep -v "Finished tests in" | grep -v "^$"
# TODO TODO: show coverage results (perhaps ratchet towards 100%, or make sure it clears a predefined minimum threshold)

exit_with_any_accumulated_errors
